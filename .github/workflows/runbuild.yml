name: Auto Test Avemujica

on:
  schedule:
    # æ¯å¤© UTC 00:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      test_rounds:
        description: 'æµ‹è¯•è½®æ¬¡'
        required: false
        default: '5'
      test_duration_min:
        description: 'å•è½®æµ‹é€Ÿæœ€å°æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰'
        required: false
        default: '15'
      test_duration_max:
        description: 'å•è½®æµ‹é€Ÿæœ€å¤§æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰'
        required: false
        default: '25'
      wait_interval_min:
        description: 'è½®æ¬¡é—´éš”æœ€å°ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰'
        required: false
        default: '15'
      wait_interval_max:
        description: 'è½®æ¬¡é—´éš”æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰'
        required: false
        default: '30'

jobs:
  speed-test:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install selenium webdriver-manager

      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v2
        with:
          chrome-version: stable
          install-chromedriver: true

      - name: éªŒè¯çŽ¯å¢ƒ
        run: |
          echo "Python ç‰ˆæœ¬:"
          python --version
          echo "Chrome ç‰ˆæœ¬:"
          chromium-browser --version
          echo "ChromeDriver ç‰ˆæœ¬:"
          chromedriver --version

      - name: è®¾ç½®çŽ¯å¢ƒå˜é‡
        env:
          TEST_URLS: ${{ secrets.TEST_URLS }}
          TEST_ROUNDS: ${{ github.event.inputs.test_rounds || secrets.TEST_ROUNDS || '5' }}
          TEST_DURATION_MIN: ${{ github.event.inputs.test_duration_min || secrets.TEST_DURATION_MIN || '15' }}
          TEST_DURATION_MAX: ${{ github.event.inputs.test_duration_max || secrets.TEST_DURATION_MAX || '25' }}
          WAIT_INTERVAL_MIN: ${{ github.event.inputs.wait_interval_min || secrets.WAIT_INTERVAL_MIN || '15' }}
          WAIT_INTERVAL_MAX: ${{ github.event.inputs.wait_interval_max || secrets.WAIT_INTERVAL_MAX || '30' }}
          USE_RANDOM_UA: ${{ secrets.USE_RANDOM_UA || 'true' }}
          CUSTOM_UA: ${{ secrets.CUSTOM_UA }}
          IPV4: ${{ secrets.IPV4 }}
          METHOD: ${{ secrets.METHOD || 'get' }}
          REFERER: ${{ secrets.REFERER }}
          COOKIES: ${{ secrets.COOKIES }}
          REDIRECT_NUM: ${{ secrets.REDIRECT_NUM || '5' }}
          DNS_SERVER_TYPE: ${{ secrets.DNS_SERVER_TYPE || 'isp' }}
          DNS_SERVER: ${{ secrets.DNS_SERVER }}
          ENABLE_LINES: ${{ secrets.ENABLE_LINES || '1,2,3,5' }}
          ENABLE_SCREENSHOT: ${{ secrets.ENABLE_SCREENSHOT || 'false' }}
        run: |
          echo "çŽ¯å¢ƒå˜é‡é…ç½®å®Œæˆ"
          echo "TEST_URLS: ${TEST_URLS:0:30}..."
          echo "TEST_ROUNDS: $TEST_ROUNDS"
          echo "TEST_DURATION_MIN: $TEST_DURATION_MIN"
          echo "TEST_DURATION_MAX: $TEST_DURATION_MAX"
          echo "WAIT_INTERVAL_MIN: $WAIT_INTERVAL_MIN"
          echo "WAIT_INTERVAL_MAX: $WAIT_INTERVAL_MAX"
          echo "USE_RANDOM_UA: $USE_RANDOM_UA"
          echo "ENABLE_LINES: $ENABLE_LINES"

      - name: è¿è¡Œæµ‹é€Ÿè„šæœ¬
        env:
          TEST_URLS: ${{ secrets.TEST_URLS }}
          TEST_ROUNDS: ${{ github.event.inputs.test_rounds || secrets.TEST_ROUNDS || '5' }}
          TEST_DURATION_MIN: ${{ github.event.inputs.test_duration_min || secrets.TEST_DURATION_MIN || '15' }}
          TEST_DURATION_MAX: ${{ github.event.inputs.test_duration_max || secrets.TEST_DURATION_MAX || '25' }}
          WAIT_INTERVAL_MIN: ${{ github.event.inputs.wait_interval_min || secrets.WAIT_INTERVAL_MIN || '15' }}
          WAIT_INTERVAL_MAX: ${{ github.event.inputs.wait_interval_max || secrets.WAIT_INTERVAL_MAX || '30' }}
          USE_RANDOM_UA: ${{ secrets.USE_RANDOM_UA || 'true' }}
          CUSTOM_UA: ${{ secrets.CUSTOM_UA }}
          IPV4: ${{ secrets.IPV4 }}
          METHOD: ${{ secrets.METHOD || 'get' }}
          REFERER: ${{ secrets.REFERER }}
          COOKIES: ${{ secrets.COOKIES }}
          REDIRECT_NUM: ${{ secrets.REDIRECT_NUM || '5' }}
          DNS_SERVER_TYPE: ${{ secrets.DNS_SERVER_TYPE || 'isp' }}
          DNS_SERVER: ${{ secrets.DNS_SERVER }}
          ENABLE_LINES: ${{ secrets.ENABLE_LINES || '1,2,3,5' }}
          ENABLE_SCREENSHOT: ${{ secrets.ENABLE_SCREENSHOT || 'false' }}
        run: |
          python run.py

      - name: æ£€æŸ¥ç»“æžœç›®å½•
        if: always()
        run: |
          echo "æ£€æŸ¥ç»“æžœç›®å½•..."
          if [ -d "result" ]; then
            echo "ç»“æžœç›®å½•å­˜åœ¨"
            ls -lh result/
            echo "ç»“æžœæ–‡ä»¶ç»Ÿè®¡:"
            find result -type f | wc -l
          else
            echo "è­¦å‘Š: ç»“æžœç›®å½•ä¸å­˜åœ¨"
          fi

      - name: ç”Ÿæˆç»“æžœæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“Š æµ‹é€Ÿç»“æžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "result" ]; then
            echo "âœ… æµ‹è¯•å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç»“æžœæ–‡ä»¶ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "- æ€»æ–‡ä»¶æ•°: $(find result -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
            echo "- å•æ¬¡ç»“æžœ: $(find result -name 'test_*.txt' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
            echo "- æ±‡æ€»æ–‡ä»¶: $(find result -name 'summary_*.json' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### æœ€æ–°æ±‡æ€»ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            if [ -f "$(ls -t result/summary_*.json 2>/dev/null | head -1)" ]; then
              echo '```json' >> $GITHUB_STEP_SUMMARY
              cat $(ls -t result/summary_*.json | head -1) >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ æµ‹è¯•å¤±è´¥ - æ²¡æœ‰ç”Ÿæˆç»“æžœç›®å½•" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸Šä¼ ç»“æžœåˆ° Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: speed-test-results
          path: result/
          retention-days: 30
          compression-level: 6


      - name: æ¸…ç†ç©ºé—´
        if: always()
        run: |
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf ~/.cache/pip
          du -sh result/ 2>/dev/null || true

      - name: å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "::error::æµ‹é€Ÿä»»åŠ¡å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦æƒ…"
